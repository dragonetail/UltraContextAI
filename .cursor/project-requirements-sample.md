`项目需求规则 *@docs/project-requirements.md* 你将使用工具代码库来了解这个 *@docs/project-requirements.md* 目录文件的详细信息，以检查项目需求和你需要遵循的项目标准。这将作为指南，确保你遵循项目标准。因此，在规划和实施项目时，请务必阅读此内容，以避免重复、冲突和错误。不要触碰该文件夹和文件，你只需阅读它。不要过度执行以至于不遵循项目需求。不要删除第1行！！！！`


# 会计网站项目需求

## 核心功能
1. **计算引擎**
   - 财务比率分析
   - 折旧计算（直线法和余额递减法）
   - 税务计算
   - 盈亏平衡分析
   - 现金流预测

2. **财务报表生成器**
   - 资产负债表模板
   - 收益表构建器
   - 现金流量表向导
   - 自定义报表创建

3. **实时协作**
   - 多用户编辑
   - 版本控制
   - 变更跟踪
   - 审计跟踪

4. **数据管理**
   - CSV/Excel导入/导出
   - 云同步功能
   - 数据验证规则
   - 历史数据比较

## 技术规格
**前端：**
- 移动优先方法
- Next.js 14（应用路由器）
- TypeScript
- Tailwind CSS + Shadcn UI
- Recharts（数据可视化）
- Math.js（计算）
- Zustand（状态管理）
- Framer motion（动画）

**后端：**
- Next.js API路由
- Supabase（PostgreSQL数据库）
- Supabase Auth
- Supabase Realtime
- Supabase存储（用于文件）
- Prisma ORM（可选）
- Zod（验证）

**关键集成：**
- 税率：Supabase边缘函数（自包含）
- 货币汇率：Supabase PostgreSQL扩展
- PDF导出：Supabase存储 + React-PDF
- CSV处理：Supabase导入/导出

## 安全要求
1. 静态数据AES-256加密
2. 传输中数据使用TLS 1.3
3. 基于角色的访问控制（RBAC）
4. 活动日志和审计跟踪
5. SOC 2合规（未来阶段）

## 合规要求
- GAAP/IFRS合规检查
- 税务法规更新
- 数据保留政策
- 可访问性（WCAG 2.1 AA）
- GDPR就绪架构

## 文档标准
1. 所有计算的内联TSDoc注释
2. API的OpenAPI规范
3. 数据库模式的ER图
4. 审计跟踪文档
5. 财务公式注册表

## 项目路线图（更新的实施顺序）

### 阶段1 - 核心会计功能（2-3周）
**实施顺序**：
1. **项目基础设施设置**（1天）
   - Supabase初始化
   - 带TypeScript的Next.js样板
   - 核心组件结构
   - 错误边界设置

2. **计算引擎基础**（5天）
   - [ ] Math.js集成
   - [ ] 折旧计算器（直线法）
   - [ ] 财务比率公式
   - [ ] 计算验证系统
   - [ ] 单元测试设置

3. **财务报表模板**（4天）
   - [ ] 资产负债表组件
   - [ ] 收益表构建器
   - [ ] PDF导出功能
   - [ ] 数据验证模式

4. **本地数据管理**（3天）
   - [ ] 本地存储集成
   - [ ] 数据加密设置
   - [ ] 历史版本控制
   - [ ] CSV导出（基本）

5. **UI/UX基础**（3天）
   - [ ] 移动优先响应式布局
   - [ ] 可访问的表单组件
   - [ ] 数据可视化（Recharts）
   - [ ] 暗黑模式支持
   - [ ] 加载/错误状态

6. **基本安全**（2天）
   - [ ] 输入净化
   - [ ] 审计日志
   - [ ] 速率限制
   - [ ] 错误边界

### 阶段2 - 数据管理（1-2周）
**优先级**：★★★☆☆
**实施顺序**：
1. **认证系统**（3天）
   - [ ] Supabase认证设置
   - [ ] 用户资料管理
   - [ ] 会话管理
   - [ ] 基本RBAC角色

2. **云数据迁移**（4天）
   - [ ] Supabase数据库架构
   - [ ] 本地→云迁移工具
   - [ ] 静态数据加密
   - [ ] 冲突解决

3. **高级CSV处理**（3天）
   - [ ] 批量导入/导出
   - [ ] 数据验证规则
   - [ ] 模板系统
   - [ ] 错误报告

### 阶段3 - 协作功能（2周）
**优先级**：★★☆☆☆
**实施顺序**：
1. **实时基础**（3天）
   - [ ] Supabase实时设置
   - [ ] 在线指示器
   - [ ] 基本协同编辑
   - [ ] 连接状态

2. **版本控制**（4天）
   - [ ] 变更跟踪
   - [ ] 版本历史
   - [ ] 快照系统
   - [ ] 回滚功能

3. **协作工具**（3天）
   - [ ] 评论系统
   - [ ] @提及
   - [ ] 通知
   - [ ] 活动提要

------`不要阅读和实施这个阶段4，这只是让你知道我们将来要实施的功能`------
### 阶段4 - 高级功能（可选）
**优先级**：★☆☆☆☆
**实施顺序**：
1. **银行集成**（5天）
   - [ ] Plaid沙盒设置
   - [ ] 交易导入
   - [ ] 对账工具
   - [ ] Webhook处理器

2. **多币种**（3天）
   - [ ] 汇率系统
   - [ ] 货币转换器
   - [ ] 本地化
   - [ ] 外汇盈亏计算

3. **自动化**（4天）
   - [ ] 税务规则引擎
   - [ ] 定时报告
   - [ ] 合规检查
   - [ ] 审计跟踪

4. **高级报告**（3天）
   - [ ] 自定义模板
   - [ ] 数据可视化
   - [ ] 执行仪表板
   - [ ] 导出格式

------`不要阅读和实施这个阶段4，这只是让你知道我们将来要实施的功能`------

## 成本分析
| 功能             | Supabase服务             | 免费层限制                     |
|------------------|--------------------------|-------------------------------|
| 数据库           | PostgreSQL               | 500MB数据库 + 1GB带宽         |
| 认证             | 认证                     | 50k月活用户                    |
| 实时             | 实时更新                 | 50个并发连接                  |
| 存储             | 文件存储                 | 1GB存储，1M下载次数           |
| 边缘函数         | 无服务器函数             | 每月500k调用次数              |
| 向量             | PostgreSQL扩展           | 随数据库免费                  |

## 实施优势
1. 所有后端需求的单一供应商
2. 统一的认证系统
3. 数据库<>存储直接集成
4. 简化的计费和监控
5. 内置速率限制和安全性

## 架构指南

### 1. 模块化结构
```
src/
├── app/               # Next.js应用路由器
├── components/        # 可重用UI组件
│   ├── core/          # 基础组件（按钮，输入框）
│   ├── accounting/    # 领域特定组件
│   └── shared/       # 跨功能组件
├── lib/
│   ├── api/           # API客户端
│   ├── hooks/         # 自定义钩子
│   ├── utils/         # 辅助函数
│   └── validation/    # Zod模式
├── types/             # 全局TS类型
```

### 2. 服务器/客户端分离
- **服务器组件**：默认使用服务器组件用于：
  - 数据获取
  - 敏感操作
  - 静态内容
- **客户端组件**：仅在需要时使用，用于：
  - 交互性
  - 浏览器API
  - 状态管理

### 3. 可重用组件
1. 创建原子组件，包含：
   - 使用TypeScript接口的PropTypes
   - 用于文档的Storybook故事
   - 默认的可访问性属性
2. 遵循命名约定：
   - `功能组件名称.tsx`（例如`DepreciationCalculator.tsx`）
   - `核心组件名称.tsx`（例如`FormInput.tsx`）

### 4. API设计规则
- 版本化端点：`/api/v1/...`
- 资源的RESTful结构
- 错误格式标准化：
  ```ts
  interface APIError {
    code: string;
    message: string;
    details?: Record<string, unknown>;
  }
  ```
